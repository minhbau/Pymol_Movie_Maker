<tool id="movie_maker_basic" name="Movie Maker">
  <description>produces a PyMol session for the creation of a protein ligand interaction movie</description>
    <!-- Show Error messages in right sidebar -->
    <stdio>
        <!-- Anything other than zero is an error -->
        <exit_code range="1:" />
        <exit_code range=":-1" />
        <!-- In case the return code has not been set properly check stderr too -->
        <regex match="Error:" />
        <regex match="Exception:" />
    </stdio>
    <!-- old command structure: <command interpreter="bash">movie_maker_basic.sh '$input' '$residue_name' '$chain' '$colorblind_save.selection' '$output' '$output2'</command> -->
    <!-- use cheetah template engine for interpretation and decision making on variables instead of just bash -->
    <command>
      <![CDATA[

        #if $advanced_options.advanced_mode == "advanced":
            bash /home/webservices/galaxy_project/galaxy-dist/tools/customTools/movie_maker/movie_maker_advanced.sh
        #else:
            #if $advanced_options.advanced_mode == "super_basic":
                bash /home/webservices/galaxy_project/galaxy-dist/tools/customTools/movie_maker/movie_maker_super_basic.sh
            #else:
                bash /home/webservices/galaxy_project/galaxy-dist/tools/customTools/movie_maker/movie_maker_basic.sh
            #end if
        #end if

        '$input'

        #if ($advanced_options.advanced_mode == "advanced") or ($advanced_options.advanced_mode == "basic"):
            '$advanced_options.residue_name'
            '$advanced_options.chain'
            '$advanced_options.colorblind_save.selection'
        #end if

        '$output'
        '$output_polar_interaction_partners'
        '$output_pymol_movie_script'

        #if $advanced_options.advanced_mode == "advanced":
            '$advanced_options.binding_site_radius.selection'
            '$advanced_options.check_halogen_interaction'
            '$advanced_options.water_in_binding_site'
            '$advanced_options.color_carbon'
            '$advanced_options.session_export_version'

            #if $advanced_options.cofactor_check.cofactor_in_binding_site:
                '$advanced_options.cofactor_check.cofactor_name'
                '$advanced_options.cofactor_check.color_carbon_cofactor'
            #end if

        #end if
        ]]>
  </command>
  <inputs>
    <param format="pdb" name="input" type="data" label="Source file"/>

    <conditional name="advanced_options" >
    <param label="Use advanced options" name="advanced_mode" type="select">
        <option value="super_basic">Use super basic mode</option>
        <option selected="True" value="basic">Use basic mode</option>
        <option value="advanced">Use advanced mode</option>
    </param>>

        <when value="super_basic"></when>
        <when value="basic">
            <param format="text" name="residue_name" size="3" type="text" label="Insert 3 letter ligand residue name">
                <validator type="regex" message="Wrong format! Please enter just 3 letters.">^[A-Z,a-z,0-9]{3}$</validator>
            </param>

            <param format="text" name="chain" size="1" type="text" label="Chain">
                <validator type="regex" message="Wrong format! Please enter just 1 letter.">^[A-Z,a-z]{1}$</validator>
            </param>

            <conditional name="colorblind_save">
                <param name="selection" type="select" label="Use colorblind save coloring">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </param>
            </conditional>
            <param name="color_carbon" type="select" label="Color of ligand backbone">
                <option value="yellow">Yellow</option>
                <option value="grey">Grey</option>
                <option value="orange">Orange</option>
            </param>
            <param name="session_export_version" type="select" label="Select target version for PyMol session">
                <option value="1.2" selected="True">1.2 Legacy support (2009)</option>
                <option value="1.72">1.72 Volumes support (2014)</option>
                <option value="1.76">1.76 Scenes support (2015)</option>
                <option value="1.84">1.84 Recent version (late 2016)</option>
            </param>
        </when>


        <when value="advanced">
            <param format="text" name="residue_name" size="3" type="text" label="Insert 3 letter ligand residue name">
                <validator type="regex" message="Wrong format! Please enter just 3 letters.">^[A-Z,a-z,0-9]{3}$</validator>
            </param>

            <param format="text" name="chain" size="1" type="text" label="Chain">
                <validator type="regex" message="Wrong format! Please enter just 1 letter.">^[A-Z,a-z]{1}$</validator>
            </param>

            <conditional name="colorblind_save">
                <param name="selection" type="select" label="Use colorblind save coloring">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </param>
            </conditional>
            <param name="color_carbon" type="select" label="Color of ligand backbone">
                <option value="yellow">Yellow</option>
                <option value="grey">Grey</option>
                <option value="orange">Orange</option>
            </param>
            <param name="session_export_version" type="select" label="Select target version for PyMol session">
                <option value="1.2" selected="True">1.2 Legacy support (2009)</option>
                <option value="1.72">1.72 Volumes support (2014)</option>
                <option value="1.76">1.76 Scenes support (2015)</option>
                <option value="1.84">1.84 Recent version (late 2016)</option>
            </param>
            <conditional name="binding_site_radius">
                <param name="selection" type="select" label="Define size of binding pocket">
                    <option value="4.0" selected="True">4.0 A</option>
                    <option value="4.5">4.5 A</option>
                    <option value="5.0">5.0 A</option>
                    <option value="5.5">5.5 A</option>
                    <option value="6.0">6.0 A</option>
                </param>
            </conditional>
            <param name="check_halogen_interaction" type="boolean" checked="true"
                   label="Display possible halogen interaction in binding site?"
                   selected="True"
                   truevalue="Yes" falsevalue="No">
            </param>
            <param name="water_in_binding_site" type="boolean" checked="true"
                   label="Display water in binding site?"
                   selected="True"
                   truevalue="Yes" falsevalue="No">
            </param>
            <conditional name="cofactor_check">
                <param name="cofactor_in_binding_site" type="boolean" checked="true"
                       label="Display cofactor in binding site?"
                       selected="False"
                       truevalue="Yes" falsevalue="No">
                </param>
                <when value="Yes">
                    <param format="text" name="cofactor_name" size="3" type="text" label="Insert 3 letter cofactor residue name">
                        <validator type="regex" message="Wrong format! Please enter just 3 letters.">^[A-Z,a-z,0-9]{3}$</validator>
                    </param>
                    <param name="color_carbon_cofactor" type="select" label="Color of cofactor backbone">
                        <option value="orange" selected="True">Orange</option>
                        <option value="yellow">Yellow</option>
                        <option value="grey">Grey</option>
                    </param>
                </when>
                <when value="No"></when>
            </conditional>
        </when>
    </conditional>
  </inputs>
  <outputs>
    <data format="pse" name="output" />
    <data format="txt" name="output_polar_interaction_partners" />
    <data format="pml" name="output_pymol_movie_script" />
  </outputs>

  <help>

**What it does**

This tool creates a PyMol session, which can be used to produce a movie with PyMol.

**Input Parameter**

Following parameters should be entered to allow a flawless computation:

    pdb-file
    three letter code of ligand
    chain of the binding pocket in question
    selection which colorscheme to use

Example:
    1r4l.pdb
    XX5
    A
    Yes

**Output**

The tool produces two output files.
The pymol session (\*.pse) can be downloaded as pse file and loaded with pymol.
In addition a pymol script-file (\*.pml) which was used for the generation of the scenes in the pse file, can be downloaded separately.
Pymol script files can conveniently be executed via the commandline ind the graphical interface with the command

      \@scriptfile

**DEBUGGING**

      If there is no molecule present in the binding pocket, make sure you defined the correct ligand residue name, this script will already try to guess the chain identifier.

      To check your local version of pymol open a commandline an call "pymol -c"

  </help>

</tool>
